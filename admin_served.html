<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Dashboard</title>
  <style>
    :root{--accent:#6c63ff;--muted:#f3f4f6;--card:#ffffff}
    body{font-family:Inter,Segoe UI,Arial;background:#f6f7fb;margin:0}
    .wrap{display:flex;min-height:100vh}
    .sidebar{width:240px;background:#fff;padding:24px;border-right:1px solid #eee}
    .logo{font-weight:700;color:var(--accent);margin-bottom:24px}
    .nav a{display:block;padding:10px 6px;color:#374151;text-decoration:none;border-radius:8px}
    .nav a.active{background:var(--muted);color:#111}
    .main{flex:1;padding:28px}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    .card{background:var(--card);padding:18px;border-radius:10px;box-shadow:0 1px 2px rgba(0,0,0,0.04)}
    .card h3{margin:0;font-size:12px;color:#6b7280}
    .card .num{font-size:28px;margin-top:8px}
    .section{margin-top:22px}
    .table{background:#fff;padding:12px;border-radius:8px}
    pre{white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <aside class="sidebar">
      <div class="logo">ReservaSimple</div>
      <nav class="nav">
        <a id="navInicio" class="active" href="#">Inicio</a>
        <a id="navCalendar" href="#">Calendario</a>
        <a id="navServicios" href="#">Servicios</a>
        <a id="navBarberos" href="#">Barberos</a>
        <a id="navConfig" href="#">Configuraci├│n</a>
      </nav>
    </aside>

    <main class="main">
      <div class="header">
        <h1>Panel Admin</h1>
        <div style="display:flex;gap:12px;align-items:center">
          <small id="slugLabel">Barber├¡a: <strong>test</strong></small>

          <form id="loginForm" style="display:flex;gap:8px;align-items:center">
            <input id="loginUser" placeholder="usuario" style="padding:6px;border-radius:6px;border:1px solid #ddd" />
            <input id="loginPass" type="password" placeholder="contrase├▒a" style="padding:6px;border-radius:6px;border:1px solid #ddd" />
            <button type="button" id="btnLogin" style="padding:6px 10px;border-radius:6px;background:var(--accent);color:#fff;border:none">Entrar</button>
            <button type="button" id="btnLogout" style="padding:6px 10px;border-radius:6px;background:#eee;color:#111;border:none;display:none">Salir</button>
          </form>

          <div id="tokenStatus" style="font-size:12px;color:#6b7280;margin-left:6px">No autenticado</div>
        </div>
      </div>

      <div class="cards">
        <div class="card">
          <h3>Turnos de Hoy</h3>
          <div class="num" id="turnosHoy">ÔÇö</div>
        </div>
        <div class="card">
          <h3>Cancelaciones Hoy</h3>
          <div class="num" id="cancelHoy">ÔÇö</div>
        </div>
        <div class="card">
          <h3>Turnos Pendientes</h3>
          <div class="num" id="turnosPend">ÔÇö</div>
        </div>
        <div class="card">
          <h3>Comprobantes Pendientes</h3>
          <div class="num" id="comprobantes">ÔÇö</div>
        </div>
      </div>

      <div class="section">
        <div class="card table">
          <h3>├Ültimas Cancelaciones</h3>
          <div id="cancelList">No hay cancelaciones recientes</div>
        </div>
      </div>

      <div id="inicioSection" class="section">
        <div class="card table">
          <h3>Resumen</h3>
          <div id="inicioContent">Contenido de inicio</div>
        </div>
      </div>

      <div id="serviciosSection" class="section" style="display:none">
        <div class="card table">
          <h3>Servicios</h3>
          <div id="serviciosList">Cargando...</div>
        </div>
      </div>

      <div id="barberosSection" class="section" style="display:none">
        <div class="card table">
          <h3>Barberos</h3>
          <div id="barberosList">Cargando...</div>
        </div>
      </div>

      <div id="configSection" class="section" style="display:none">
        <div class="card table">
          <h3>Configuraci├│n</h3>
          <form id="configForm" style="display:flex;flex-direction:column;gap:8px;max-width:480px">
            <input id="cfgNombre" placeholder="Nombre barber├¡a" style="padding:8px;border-radius:6px;border:1px solid #ddd" />
            <input id="cfgSlug" placeholder="Slug" style="padding:8px;border-radius:6px;border:1px solid #ddd" />
            <div style="display:flex;gap:8px">
              <input id="cfgHoraApertura" placeholder="Apertura (HH:MM)" style="padding:8px;border-radius:6px;border:1px solid #ddd" />
              <input id="cfgHoraCierre" placeholder="Cierre (HH:MM)" style="padding:8px;border-radius:6px;border:1px solid #ddd" />
            </div>
            <div>
              <button type="button" id="btnSaveConfig" style="padding:8px 12px;border-radius:6px;background:#6366f1;color:#fff;border:none">Guardar</button>
            </div>
          </form>
          <div id="configResult" style="margin-top:8px"></div>
        </div>
      </div>

      <div class="section">
        <div class="card table">
          <h3>Acciones protegidas (requieren login)</h3>

          <div style="margin-top:8px">
            <form id="createServicioForm" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <input id="svcNombre" placeholder="Nombre servicio" style="padding:6px;border-radius:6px;border:1px solid #ddd" />
              <input id="svcDur" placeholder="Duraci├│n (min)" type="number" style="width:120px;padding:6px;border-radius:6px;border:1px solid #ddd" />
              <input id="svcPrecio" placeholder="Precio" style="width:120px;padding:6px;border-radius:6px;border:1px solid #ddd" />
              <button type="button" id="btnCreateServicio" style="padding:6px 10px;border-radius:6px;background:#10b981;color:#fff;border:none">Crear Servicio</button>
            </form>
          </div>

          <div style="margin-top:12px">
            <form id="createBarberoForm" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <input id="barNombre" placeholder="Nombre" style="padding:6px;border-radius:6px;border:1px solid #ddd" />
              <input id="barApellido" placeholder="Apellido" style="padding:6px;border-radius:6px;border:1px solid #ddd" />
              <input id="barEmail" placeholder="Email" style="padding:6px;border-radius:6px;border:1px solid #ddd" />
              <input id="barUsername" placeholder="Username" style="padding:6px;border-radius:6px;border:1px solid #ddd" />
              <input id="barPassword" type="password" placeholder="Password" style="padding:6px;border-radius:6px;border:1px solid #ddd" />
              <button type="button" id="btnCreateBarbero" style="padding:6px 10px;border-radius:6px;background:#3b82f6;color:#fff;border:none">Crear Barbero</button>
            </form>
          </div>

          <div id="protectedResult" style="margin-top:12px;color:#374151"></div>
        </div>
      </div>

    </main>
  </div>

  <script>
    // Demo: usa el slug 'test' por defecto. Puedes cambiarlo din├ímicamente.
    const SLUG = 'test';

    async function fetchJson(url, opts){
      try{
        const r = await fetch(url, opts);
        if(!r.ok) throw new Error(r.status + ' ' + r.statusText);
        return await r.json();
      }catch(e){console.warn('fetch error',url,e);return null}
    }

    async function load(){
      showSection('inicio');
      await loadResumen();
    }

    async function loadServicios(){
      const servicios = await fetchJson(`/b/${SLUG}/servicios`);
      const el = document.getElementById('serviciosList');
      if(servicios){
        el.innerHTML = servicios.map(s=>`<div><strong>${s.nombre}</strong> ÔÇö ${s.duracion_minutos} min ÔÇö $${s.precio}</div>`).join('');
      } else {
        el.textContent = 'Error cargando servicios';
      }
    }

    async function loadBarberos(){
      const barberos = await fetchJson(`/b/${SLUG}/barberos`);
      const el = document.getElementById('barberosList');
      if(barberos){
        el.innerHTML = barberos.map(b=>`<div><strong>${b.nombre} ${b.apellido}</strong> (id:${b.id})</div>`).join('');
      } else {
        el.textContent = 'Error cargando barberos';
      }
    }

    async function loadConfig(){
      const data = await fetchJson(`/b/${SLUG}`);
      if(data && data.barberia){
        const b = data.barberia;
        document.getElementById('cfgNombre').value = b.nombre || '';
        document.getElementById('cfgSlug').value = b.slug || '';
        // hora_apertura/hora_cierre come as time strings '09:00:00Z' in some responses ÔÇö try slice
        document.getElementById('cfgHoraApertura').value = (b.hora_apertura || '').slice(11,16) || '';
        document.getElementById('cfgHoraCierre').value = (b.hora_cierre || '').slice(11,16) || '';
      } else {
        document.getElementById('configResult').textContent = 'Error cargando configuraci├│n';
      }
    }

    async function loadResumen(){
      // resumen: servicios count, barberos count, agenda hoy
      const servicios = await fetchJson(`/b/${SLUG}/servicios`);
      const barberos = await fetchJson(`/b/${SLUG}/barberos`);
      const today = new Date().toISOString().slice(0,10);
      const agenda = await fetchJson(`/b/${SLUG}/agenda?fecha=${today}`);
      document.getElementById('turnosHoy').textContent = Array.isArray(agenda)? agenda.length : 'ÔÇö';
      document.getElementById('turnosPend').textContent = Array.isArray(barberos)? barberos.length : 'ÔÇö';
      document.getElementById('serviciosList').textContent = '';
      if(Array.isArray(servicios)){
        document.getElementById('serviciosList').innerHTML = servicios.map(s=>`<div>${s.nombre}</div>`).join('');
      }
      document.getElementById('cancelList').textContent = 'No hay cancelaciones recientes';
    }

    load();

    // --- Authentication and protected actions ---
    function setToken(t){
      if(t){
        localStorage.setItem('rs_token', t);
        document.getElementById('tokenStatus').textContent = 'Autenticado';
        document.getElementById('btnLogin').style.display = 'none';
        document.getElementById('btnLogout').style.display = 'inline-block';
      } else {
        localStorage.removeItem('rs_token');
        document.getElementById('tokenStatus').textContent = 'No autenticado';
        document.getElementById('btnLogin').style.display = 'inline-block';
        document.getElementById('btnLogout').style.display = 'none';
      }
    }

    async function doLogin(){
      const u = document.getElementById('loginUser').value;
      const p = document.getElementById('loginPass').value;
      const body = JSON.stringify({ username: u, password: p });
      const res = await fetch(`/login`, { method: 'POST', headers: {'Content-Type':'application/json'}, body });
      if(!res.ok){ alert('Login fall├│: '+res.status); return }
      const j = await res.json();
      setToken(j.token);
    }

    document.getElementById('btnLogin').addEventListener('click', doLogin);
    document.getElementById('btnLogout').addEventListener('click', ()=>{ setToken(null); });

    function authHeader(){
      const t = localStorage.getItem('rs_token');
      return t? { 'Authorization': 'Bearer '+t, 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };
    }

    document.getElementById('btnCreateServicio').addEventListener('click', async ()=>{
      const nombre = document.getElementById('svcNombre').value;
      const dur = parseInt(document.getElementById('svcDur').value||0,10);
      const precio = document.getElementById('svcPrecio').value||'0.00';
      const body = JSON.stringify({ nombre, duracion_minutos: dur, precio });
      const hdrs = authHeader();
      const r = await fetch(`/b/${SLUG}/servicios`, { method:'POST', headers: hdrs, body });
      if(!r.ok){ document.getElementById('protectedResult').textContent = 'Error: '+r.status; return }
      const j = await r.json(); document.getElementById('protectedResult').textContent = 'Servicio creado: '+j.id; load();
    });

    document.getElementById('btnCreateBarbero').addEventListener('click', async ()=>{
      const nombre = document.getElementById('barNombre').value;
      const apellido = document.getElementById('barApellido').value;
      const email = document.getElementById('barEmail').value;
      const username = document.getElementById('barUsername').value;
      const password = document.getElementById('barPassword').value;
      const body = JSON.stringify({ nombre, apellido, email, username, password });
      const hdrs = authHeader();
      const r = await fetch(`/b/${SLUG}/barberos`, { method:'POST', headers: hdrs, body });
      if(!r.ok){ document.getElementById('protectedResult').textContent = 'Error: '+r.status; return }
      const j = await r.json(); document.getElementById('protectedResult').textContent = 'Barbero creado: '+j.id; load();
    });

    // Initialize token state from localStorage
    setToken(localStorage.getItem('rs_token'));

    // --- Navigation and section switching ---
    function showSection(name){
      const sections = ['inicio','servicios','barberos','config'];
      sections.forEach(s=>{
        const el = document.getElementById(s+ 'Section');
        if(el) el.style.display = (s===name)? 'block' : 'none';
        const nav = document.getElementById('nav'+(s.charAt(0).toUpperCase()+s.slice(1)));
        if(nav) nav.classList.toggle('active', s===name);
      });
      // load data for the shown section
      if(name==='servicios') loadServicios();
      if(name==='barberos') loadBarberos();
      if(name==='config') loadConfig();
      if(name==='inicio') loadResumen();
    }

    document.getElementById('navServicios').addEventListener('click', (e)=>{ e.preventDefault(); showSection('servicios'); });
    document.getElementById('navBarberos').addEventListener('click', (e)=>{ e.preventDefault(); showSection('barberos'); });
    document.getElementById('navConfig').addEventListener('click', (e)=>{ e.preventDefault(); showSection('config'); });
    document.getElementById('navInicio').addEventListener('click', (e)=>{ e.preventDefault(); showSection('inicio'); });

    // Save config (protected)
    document.getElementById('btnSaveConfig').addEventListener('click', async ()=>{
      const nombre = document.getElementById('cfgNombre').value;
      const slug = document.getElementById('cfgSlug').value;
      const apertura = document.getElementById('cfgHoraApertura').value;
      const cierre = document.getElementById('cfgHoraCierre').value;
      const body = JSON.stringify({ nombre, slug, hora_apertura: apertura, hora_cierre: cierre });
      const r = await fetch(`/b/${SLUG}`, { method:'POST', headers: authHeader(), body });
      if(!r.ok){ document.getElementById('configResult').textContent = 'Error guardando: '+r.status; return }
      document.getElementById('configResult').textContent = 'Guardado OK';
    });
  </script>
</body>
</html>

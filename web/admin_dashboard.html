<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Dashboard</title>
  <style>
    :root{--accent:#6c63ff;--muted:#f3f4f6;--card:#ffffff}
    body{font-family:Inter,Segoe UI,Arial;background:#f6f7fb;margin:0}
    .wrap{display:flex;min-height:100vh}
    .sidebar{width:240px;background:#fff;padding:24px;border-right:1px solid #eee}
    .logo{font-weight:700;color:var(--accent);margin-bottom:24px}
    .nav a{display:block;padding:10px 6px;color:#374151;text-decoration:none;border-radius:8px}
    .nav a.active{background:var(--muted);color:#111}
    .main{flex:1;padding:28px}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    .card{background:var(--card);padding:18px;border-radius:10px;box-shadow:0 1px 2px rgba(0,0,0,0.04)}
    .card h3{margin:0;font-size:12px;color:#6b7280}
    .card .num{font-size:28px;margin-top:8px}
    .section{margin-top:22px}
    .table{background:#fff;padding:12px;border-radius:8px}
    pre{white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <aside class="sidebar">
      <div class="logo">ReservaSimple</div>
      <nav class="nav">
        <a class="active" href="#">Inicio</a>
        <a href="#">Calendario</a>
        <a href="#">Servicios</a>
        <a href="#">Barberos</a>
        <a href="#">Configuración</a>
      </nav>
    </aside>

    <main class="main">
      <div class="header">
        <h1>Panel Admin</h1>
        <div style="display:flex;gap:12px;align-items:center">
          <small id="slugLabel">Barbería: <strong>test</strong></small>

          <form id="loginForm" style="display:flex;gap:8px;align-items:center">
            <input id="loginUser" placeholder="usuario" style="padding:6px;border-radius:6px;border:1px solid #ddd" />
            <input id="loginPass" type="password" placeholder="contraseña" style="padding:6px;border-radius:6px;border:1px solid #ddd" />
            <button type="button" id="btnLogin" style="padding:6px 10px;border-radius:6px;background:var(--accent);color:#fff;border:none">Entrar</button>
            <button type="button" id="btnLogout" style="padding:6px 10px;border-radius:6px;background:#eee;color:#111;border:none;display:none">Salir</button>
          </form>

          <div id="tokenStatus" style="font-size:12px;color:#6b7280;margin-left:6px">No autenticado</div>
        </div>
      </div>

      <div class="cards">
        <div class="card">
          <h3>Turnos de Hoy</h3>
          <div class="num" id="turnosHoy">—</div>
        </div>
        <div class="card">
          <h3>Cancelaciones Hoy</h3>
          <div class="num" id="cancelHoy">—</div>
        </div>
        <div class="card">
          <h3>Turnos Pendientes</h3>
          <div class="num" id="turnosPend">—</div>
        </div>
        <div class="card">
          <h3>Comprobantes Pendientes</h3>
          <div class="num" id="comprobantes">—</div>
        </div>
      </div>

      <div class="section">
        <div class="card table">
          <h3>Últimas Cancelaciones</h3>
          <div id="cancelList">No hay cancelaciones recientes</div>
        </div>
      </div>

      <div class="section">
        <div class="card table">
          <h3>Servicios</h3>
          <div id="serviciosList">Cargando...</div>
        </div>
      </div>

      <div class="section">
        <div class="card table">
          <h3>Acciones protegidas (requieren login)</h3>

          <div style="margin-top:8px">
            <form id="createServicioForm" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <input id="svcNombre" placeholder="Nombre servicio" style="padding:6px;border-radius:6px;border:1px solid #ddd" />
              <input id="svcDur" placeholder="Duración (min)" type="number" style="width:120px;padding:6px;border-radius:6px;border:1px solid #ddd" />
              <input id="svcPrecio" placeholder="Precio" style="width:120px;padding:6px;border-radius:6px;border:1px solid #ddd" />
              <button type="button" id="btnCreateServicio" style="padding:6px 10px;border-radius:6px;background:#10b981;color:#fff;border:none">Crear Servicio</button>
            </form>
          </div>

          <div style="margin-top:12px">
            <form id="createBarberoForm" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <input id="barNombre" placeholder="Nombre" style="padding:6px;border-radius:6px;border:1px solid #ddd" />
              <input id="barApellido" placeholder="Apellido" style="padding:6px;border-radius:6px;border:1px solid #ddd" />
              <input id="barEmail" placeholder="Email" style="padding:6px;border-radius:6px;border:1px solid #ddd" />
              <input id="barUsername" placeholder="Username" style="padding:6px;border-radius:6px;border:1px solid #ddd" />
              <input id="barPassword" type="password" placeholder="Password" style="padding:6px;border-radius:6px;border:1px solid #ddd" />
              <button type="button" id="btnCreateBarbero" style="padding:6px 10px;border-radius:6px;background:#3b82f6;color:#fff;border:none">Crear Barbero</button>
            </form>
          </div>

          <div id="protectedResult" style="margin-top:12px;color:#374151"></div>
        </div>
      </div>

    </main>
  </div>

  <script>
    // Demo: usa el slug 'test' por defecto. Puedes cambiarlo dinámicamente.
    const SLUG = 'test';

    async function fetchJson(url, opts){
      try{
        const r = await fetch(url, opts);
        if(!r.ok) throw new Error(r.status + ' ' + r.statusText);
        return await r.json();
      }catch(e){console.warn('fetch error',url,e);return null}
    }

    async function load(){
      // Servicios
      const servicios = await fetchJson(`/b/${SLUG}/servicios`);
      if(servicios){
        const el = document.getElementById('serviciosList');
        el.innerHTML = servicios.map(s=>`<div><strong>${s.nombre}</strong> — ${s.duracion_minutos} min — $${s.precio}</div>`).join('');
        document.getElementById('turnosHoy').textContent = '—';
        document.getElementById('turnosPend').textContent = '—';
        document.getElementById('cancelHoy').textContent = '—';
      } else {
        document.getElementById('serviciosList').textContent = 'Error cargando servicios';
      }

      // Barberos count
      const barberos = await fetchJson(`/b/${SLUG}/barberos`);
      if(barberos) document.getElementById('turnosPend').textContent = barberos.length;

      // Agenda (turnos) demo: obtener turnos por fecha
      const today = new Date().toISOString().slice(0,10);
      const agenda = await fetchJson(`/b/${SLUG}/agenda?fecha=${today}`);
      if(Array.isArray(agenda)){
        document.getElementById('turnosHoy').textContent = agenda.length;
      }

      // Cancelaciones demo: (no specific endpoint) show placeholder
      document.getElementById('cancelList').textContent = 'No hay cancelaciones recientes';
    }

    load();

    // --- Authentication and protected actions ---
    function setToken(t){
      if(t){
        localStorage.setItem('rs_token', t);
        document.getElementById('tokenStatus').textContent = 'Autenticado';
        document.getElementById('btnLogin').style.display = 'none';
        document.getElementById('btnLogout').style.display = 'inline-block';
      } else {
        localStorage.removeItem('rs_token');
        document.getElementById('tokenStatus').textContent = 'No autenticado';
        document.getElementById('btnLogin').style.display = 'inline-block';
        document.getElementById('btnLogout').style.display = 'none';
      }
    }

    async function doLogin(){
      const u = document.getElementById('loginUser').value;
      const p = document.getElementById('loginPass').value;
      const body = JSON.stringify({ username: u, password: p });
      const res = await fetch(`/login`, { method: 'POST', headers: {'Content-Type':'application/json'}, body });
      if(!res.ok){ alert('Login falló: '+res.status); return }
      const j = await res.json();
      setToken(j.token);
    }

    document.getElementById('btnLogin').addEventListener('click', doLogin);
    document.getElementById('btnLogout').addEventListener('click', ()=>{ setToken(null); });

    function authHeader(){
      const t = localStorage.getItem('rs_token');
      return t? { 'Authorization': 'Bearer '+t, 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };
    }

    document.getElementById('btnCreateServicio').addEventListener('click', async ()=>{
      const nombre = document.getElementById('svcNombre').value;
      const dur = parseInt(document.getElementById('svcDur').value||0,10);
      const precio = document.getElementById('svcPrecio').value||'0.00';
      const body = JSON.stringify({ nombre, duracion_minutos: dur, precio });
      const hdrs = authHeader();
      const r = await fetch(`/b/${SLUG}/servicios`, { method:'POST', headers: hdrs, body });
      if(!r.ok){ document.getElementById('protectedResult').textContent = 'Error: '+r.status; return }
      const j = await r.json(); document.getElementById('protectedResult').textContent = 'Servicio creado: '+j.id; load();
    });

    document.getElementById('btnCreateBarbero').addEventListener('click', async ()=>{
      const nombre = document.getElementById('barNombre').value;
      const apellido = document.getElementById('barApellido').value;
      const email = document.getElementById('barEmail').value;
      const username = document.getElementById('barUsername').value;
      const password = document.getElementById('barPassword').value;
      const body = JSON.stringify({ nombre, apellido, email, username, password });
      const hdrs = authHeader();
      const r = await fetch(`/b/${SLUG}/barberos`, { method:'POST', headers: hdrs, body });
      if(!r.ok){ document.getElementById('protectedResult').textContent = 'Error: '+r.status; return }
      const j = await r.json(); document.getElementById('protectedResult').textContent = 'Barbero creado: '+j.id; load();
    });

    // Initialize token state from localStorage
    setToken(localStorage.getItem('rs_token'));
  </script>
</body>
</html>
